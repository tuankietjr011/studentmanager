<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω sinh vi√™n</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

    <h3 class="text-primary text-center fw-bold">QU·∫¢N L√ù SINH VI√äN (REST API)</h3>

    <div class="row mb-3 mt-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-primary text-white">T√¨m t√™n</span>
                <input type="text" id="searchName" class="form-control" placeholder="Nh·∫≠p t√™n..." onkeyup="searchByName()">
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-warning">T√¨m ID</span>
                <input type="text" id="searchId" class="form-control" placeholder="D√°n m√£ UUID v√†o ƒë√¢y...">
                <button class="btn btn-warning" onclick="searchById()">T√¨m</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID (UUID)</th>
                <th>T√™n</th>
                <th>Tu·ªïi</th>
                <th style="width: 150px;">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="studentTable">
            </tbody>
    </table>
    
    <button class="btn btn-outline-primary mb-4 btn-sm" onclick="loadStudents()">üîÑ T·∫£i l·∫°i danh s√°ch g·ªëc</button>

    <hr>

    <div class="card p-3 shadow-sm bg-light">
        <h4 id="formTitle" class="text-success">Th√™m sinh vi√™n m·ªõi</h4>
        <input type="hidden" id="hiddenId">

        <div class="row g-2">
            <div class="col-md-6">
                <input id="name" type="text" class="form-control" placeholder="Nh·∫≠p T√™n sinh vi√™n">
            </div>
            <div class="col-md-3">
                <input id="age" type="number" class="form-control" placeholder="Tu·ªïi">
            </div>
            <div class="col-md-3">
                <button id="btnSave" class="btn btn-success w-100" onclick="saveStudent()">L∆∞u th√¥ng tin</button>
            </div>
            <div class="col-md-12 text-end">
                <button onclick="resetForm()" class="btn btn-secondary btn-sm">H·ªßy b·ªè / L√†m m·ªõi</button>
            </div>
        </div>
    </div>

    <script>
        // ƒê∆∞·ªùng d·∫´n API g·ªëc
        const API = "/api/students"; 

        // 1. T·∫£i danh s√°ch khi v√†o trang
        async function loadStudents() {
            try {
                let res = await fetch(API);
                let data = await res.json();
                renderTable(data);
            } catch (e) { console.error("L·ªói t·∫£i trang:", e); }
        }

        // H√†m v·∫Ω b·∫£ng d·ªØ li·ªáu
        function renderTable(data) {
            let html = "";
            const list = Array.isArray(data) ? data : [data]; // √âp v·ªÅ m·∫£ng n·∫øu l√† object l·∫ª

            if(list.length === 0 || !list[0]) {
                html = '<tr><td colspan="4" class="text-center text-danger fw-bold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o</td></tr>';
            } else {
                list.forEach(s => {
                    if(s) {
                        html += `
                        <tr>
                            <td><small class="text-muted">${s.id}</small></td> <td class="fw-bold">${s.name}</td>
                            <td>${s.age}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editForm('${s.id}')">S·ª≠a</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteStudent('${s.id}')">X√≥a</button>
                            </td>
                        </tr>`;
                    }
                });
            }
            document.getElementById("studentTable").innerHTML = html;
        }

        // 2. T√¨m theo ID
        async function searchById() {
            const id = document.getElementById("searchId").value.trim();
            if(!id) { alert("Vui l√≤ng nh·∫≠p ID!"); return; }
            try {
                let res = await fetch(`${API}/${id}`);
                if(res.ok) {
                    let data = await res.json();
                    renderTable(data);
                } else {
                    renderTable([]); // Kh√¥ng t√¨m th·∫•y
                }
            } catch (e) { renderTable([]); }
        }

        // 3. T√¨m theo t√™n
        async function searchByName() {
            const name = document.getElementById("searchName").value;
            if (!name) { loadStudents(); return; }
            
            let res = await fetch(`${API}/search?name=${name}`);
            let data = await res.json();
            renderTable(data);
        }

        // 4. L∆∞u (T·ª± ƒë·ªông nh·∫≠n di·ªán Th√™m m·ªõi ho·∫∑c C·∫≠p nh·∫≠t)
        async function saveStudent() {
            const id = document.getElementById("hiddenId").value;
            const name = document.getElementById("name").value;
            const age = document.getElementById("age").value;

            if (!name || !age) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß t√™n v√† tu·ªïi!"); return; }
            
            const studentData = { name: name, age: age };

            // Logic: C√≥ ID th√¨ l√† S·ª¨A, Kh√¥ng c√≥ ID th√¨ l√† TH√äM
            if (id) {
                // G·ªåI API S·ª¨A (PUT) - ƒê√£ s·ª≠a ƒë√∫ng chu·∫©n
                await fetch(`${API}/${id}`, { 
                    method: "PUT", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(studentData)
                });
            } else {
                // G·ªåI API TH√äM (POST)
                await fetch(API, { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(studentData)
                });
            }
            
            resetForm(); 
            loadStudents(); 
        }

        // 5. ƒê·ªï d·ªØ li·ªáu l√™n form ƒë·ªÉ s·ª≠a
        async function editForm(id) {
            // G·ªçi API l·∫•y chi ti·∫øt ƒë·ªÉ ƒëi·ªÅn v√†o √¥ input
            let res = await fetch(`${API}/${id}`);
            let student = await res.json();
            
            document.getElementById("hiddenId").value = student.id;
            document.getElementById("name").value = student.name;
            document.getElementById("age").value = student.age;
            
            // ƒê·ªïi giao di·ªán n√∫t b·∫•m
            document.getElementById("formTitle").innerText = "ƒêang ch·ªânh s·ª≠a sinh vi√™n";
            document.getElementById("formTitle").className = "text-warning";
            document.getElementById("btnSave").innerText = "C·∫≠p nh·∫≠t";
            document.getElementById("btnSave").className = "btn btn-warning w-100";
        }

        // 6. X√≥a sinh vi√™n
        async function deleteStudent(id) {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a sinh vi√™n n√†y kh√¥ng?")) {
                // G·ªåI API X√ìA (DELETE) - ƒê√£ s·ª≠a ƒë√∫ng chu·∫©n
                await fetch(`${API}/${id}`, { method: "DELETE" });
                loadStudents();
            }
        }

        // Reset form v·ªÅ tr·∫°ng th√°i th√™m m·ªõi
        function resetForm() {
            document.getElementById("hiddenId").value = "";
            document.getElementById("name").value = "";
            document.getElementById("age").value = "";
            
            document.getElementById("formTitle").innerText = "Th√™m sinh vi√™n m·ªõi";
            document.getElementById("formTitle").className = "text-success";
            document.getElementById("btnSave").innerText = "L∆∞u";
            document.getElementById("btnSave").className = "btn btn-success w-100";
        }

        // Ch·∫°y l·∫ßn ƒë·∫ßu
        loadStudents();
    </script>

</body>
</html>