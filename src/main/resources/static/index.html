<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sinh viên</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

    <h3 class="text-primary">QUẢN LÝ SINH VIÊN</h3>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">Tìm tên</span>
                <input type="text" id="searchName" class="form-control" placeholder="Nhập tên..." onkeyup="searchByName()">
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">Tìm ID</span>
                <input type="number" id="searchId" class="form-control" placeholder="Nhập số ID...">
                <button class="btn btn-primary" onclick="searchById()">Tìm</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Tên</th>
                <th>Tuổi</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="studentTable">
            </tbody>
    </table>
    
    <button class="btn btn-outline-secondary mb-3 btn-sm" onclick="loadStudents()">Tải lại danh sách đầy đủ</button>

    <hr>

    <h4 id="formTitle">Thêm sinh viên mới</h4>
    <input type="hidden" id="hiddenId">

    <div class="row g-2">
        <div class="col-md-7">
            <input id="name" type="text" class="form-control" placeholder="Nhập Tên">
        </div>
        <div class="col-md-3">
            <input id="age" type="number" class="form-control" placeholder="Nhập Tuổi">
        </div>
        <div class="col-md-2">
            <button id="btnSave" class="btn btn-success w-100" onclick="saveStudent()">Lưu</button>
        </div>
        <div class="col-md-12">
            <button onclick="resetForm()" class="btn btn-secondary btn-sm">Hủy / Làm mới</button>
        </div>
    </div>

    <script>
        const API = "/api/students"; 

        // 1. Tải danh sách
        async function loadStudents() {
            try {
                let res = await fetch(API);
                let data = await res.json();
                renderTable(data);
            } catch (e) { console.error(e); }
        }

        // Vẽ bảng (Hỗ trợ cả mảng danh sách lẫn 1 đối tượng lẻ)
        function renderTable(data) {
            let html = "";
            // Nếu data không phải là mảng (do tìm theo ID trả về 1 object), ta ép nó vào mảng
            const list = Array.isArray(data) ? data : [data];

            if(list.length === 0 || !list[0]) {
                html = '<tr><td colspan="4" class="text-center text-danger">Không tìm thấy dữ liệu</td></tr>';
            } else {
                list.forEach(s => {
                    if(s) { // Kiểm tra s tồn tại
                        html += `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.age}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editForm(${s.id})">Sửa</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.id})">Xóa</button>
                            </td>
                        </tr>`;
                    }
                });
            }
            document.getElementById("studentTable").innerHTML = html;
        }

        // [MỚI] Hàm Tìm theo ID
        async function searchById() {
            const id = document.getElementById("searchId").value;
            if(!id) {
                alert("Vui lòng nhập ID!");
                return;
            }
            try {
                // Gọi API Get Detail (Yêu cầu 4)
                let res = await fetch(`${API}/${id}`);
                if(res.ok) {
                    let data = await res.json();
                    if(data) {
                        renderTable(data); // Hiển thị sinh viên tìm được
                    } else {
                        renderTable([]); // Không tìm thấy
                    }
                } else {
                    renderTable([]);
                }
            } catch (e) {
                renderTable([]);
            }
        }

        // Tìm theo tên
        async function searchByName() {
            const name = document.getElementById("searchName").value;
            if (!name) { loadStudents(); return; }
            let res = await fetch(`${API}/search?name=${name}`);
            let data = await res.json();
            renderTable(data);
        }

        // Lưu (Thêm hoặc Sửa)
        async function saveStudent() {
            const id = document.getElementById("hiddenId").value;
            const name = document.getElementById("name").value;
            const age = document.getElementById("age").value;

            if (!name || !age) { alert("Nhập thiếu thông tin!"); return; }
            const studentData = { name: name, age: age };

            if (id) {
                await fetch(`${API}/update/${id}`, { // POST Update
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(studentData)
                });
            } else {
                await fetch(API, { // POST Add
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(studentData)
                });
            }
            resetForm(); 
            loadStudents(); 
        }

        // Chuẩn bị form Sửa
        async function editForm(id) {
            let res = await fetch(`${API}/${id}`);
            let student = await res.json();
            document.getElementById("hiddenId").value = student.id;
            document.getElementById("name").value = student.name;
            document.getElementById("age").value = student.age;
            document.getElementById("formTitle").innerText = "Đang sửa ID: " + id;
            document.getElementById("btnSave").innerText = "Cập nhật";
            document.getElementById("btnSave").className = "btn btn-warning w-100";
        }

        // Xóa
        async function deleteStudent(id) {
            if(confirm("Xóa nhé?")) {
                await fetch(`${API}/delete/${id}`, { method: "POST" }); // POST Delete
                loadStudents();
            }
        }

        function resetForm() {
            document.getElementById("hiddenId").value = "";
            document.getElementById("name").value = "";
            document.getElementById("age").value = "";
            document.getElementById("formTitle").innerText = "Thêm sinh viên mới";
            document.getElementById("btnSave").innerText = "Lưu";
            document.getElementById("btnSave").className = "btn btn-success w-100";
        }

        loadStudents();
    </script>

</body>
</html>